# ═══════════════════════════════════════════════════
# FileHub — Development Build with Hot Reload
# ═══════════════════════════════════════════════════

FROM rust:1.77-bookworm

# Install development dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    libpq-dev \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install cargo-watch for hot reload
RUN cargo install cargo-watch

# Install sqlx-cli for migrations
RUN cargo install sqlx-cli --no-default-features --features postgres

WORKDIR /app

# Copy workspace manifests
COPY Cargo.toml Cargo.lock ./
COPY crates/filehub-core/Cargo.toml crates/filehub-core/
COPY crates/filehub-entity/Cargo.toml crates/filehub-entity/
COPY crates/filehub-database/Cargo.toml crates/filehub-database/
COPY crates/filehub-cache/Cargo.toml crates/filehub-cache/
COPY crates/filehub-storage/Cargo.toml crates/filehub-storage/
COPY crates/filehub-auth/Cargo.toml crates/filehub-auth/
COPY crates/filehub-service/Cargo.toml crates/filehub-service/
COPY crates/filehub-realtime/Cargo.toml crates/filehub-realtime/
COPY crates/filehub-worker/Cargo.toml crates/filehub-worker/
COPY crates/filehub-plugin/Cargo.toml crates/filehub-plugin/
COPY crates/filehub-plugin-sdk/Cargo.toml crates/filehub-plugin-sdk/
COPY crates/filehub-api/Cargo.toml crates/filehub-api/
COPY crates/plugin-flexnet/Cargo.toml crates/plugin-flexnet/
COPY crates/plugin-cad-converter/Cargo.toml crates/plugin-cad-converter/
COPY crates/filehub-cli/Cargo.toml crates/filehub-cli/

# Create dummy source files for dependency pre-build
RUN mkdir -p src && echo "fn main() {}" > src/main.rs
RUN for dir in crates/*/; do \
        mkdir -p "$dir/src" && \
        echo "" > "$dir/src/lib.rs"; \
    done
RUN mkdir -p crates/filehub-cli/src && echo "fn main() {}" > crates/filehub-cli/src/main.rs

# Pre-build dependencies
RUN cargo build 2>/dev/null || true

# Clean dummy files (source will be mounted via volume)
RUN find . -name "*.rs" -path "*/src/*" -delete

# Environment
ENV FILEHUB_CONFIG=/app/config/default.toml
ENV FILEHUB_ENV=development
ENV RUST_LOG=debug
ENV RUST_BACKTRACE=1

EXPOSE 8080 8081

# Hot reload command
CMD ["cargo", "watch", "-x", "run", "-w", "src", "-w", "crates"]